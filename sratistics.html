<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <title>Статистика Metadata devtraining</title>
</head>

<body onload=loadtasks(1)>


<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>

<script>
    var numberchart = 5;
    var points = [];
    var asyncCount = 0;
    var countReps = 1000000;
    function loadtasks(page) {
        var reps = [];
			
		reps.push("oknosoft/helloworld");
        countReps = 0;//reps.length;
        reps.forEach(function (item, i1, arr1) {
			var end = false;
			//var page = 1;
			//while(!(page>1)) {
			
            
			var xhr = new XMLHttpRequest();
            xhr.open('GET', 'https://api.github.com/repos/' + item + '/forks?state=closed&page=' + page + '&per_page=100', true);
			//page++;
			
            xhr.onreadystatechange = function () {
                if (xhr.readyState != 4) return;
                if (xhr.status != 200) {
                    // обработать ошибку
                    console.log(xhr.status + ': ' + xhr.statusText);
                    asyncCount++;
					if(asyncCount==countReps){
						alert('ready');}
                } else {
                    try {
                        var tasks = JSON.parse(xhr.responseText);
						if (tasks.length < 100){
						end = true;
						}
                        tasks.forEach(function (task, i2, arr2) {
                                        currentDate = GetWeekBegin(task.created_at);
										if(currentDate.getFullYear() >= 2018){
                                        haveIt = false;
                                        points.forEach(function(point, i4, arr4) {
                                            if ((point[0]-currentDate)==0) {
                                                point[1]+=1;
												
                                                haveIt = true;
                                            }
                                        })
                                        if (!haveIt) {
                                            y = [];
                                            y.push(currentDate);
                                            y.push(1);
											
                                            points.push(y);
                                        }
                        }})
                        asyncCount++;
						//if(asyncCount==countReps){
						//alert('ready');}
                    } catch (e) {
                        alert("Некорректный ответ " + e.message);
                        asyncCount++;
						//if(asyncCount==countReps){
						//alert('ready');}
                    }
                    tryDraw();
                }
            }
			countReps++;
            xhr.send();
        });
    }
    function tryDraw(){
        if (asyncCount==countReps) {
            google.charts.load('current', {'packages': ['corechart']});
            google.charts.setOnLoadCallback(drawChart);
        }
    }
    function drawChart() {
        points.sort(function(a, b) {
            if (a[0] > b[0]) {
                return 1;
            }
            if (a[0] < b[0]) {
                return -1;
            }
            return 0;
        });
        points.unshift(["Дата", "Форки"]);
        var data = google.visualization.arrayToDataTable(points);
        var options = {
            title: "Форки",
            curveType: 'function',
            legend: {position: 'bottom'},
            pointSize: 5,
            series: {
                0: {
                    lineWidth: 1,
                    pointShape: 'circle'
                    //lineDashStyle: [5, 1, 5]
                }
            }
        };
        var div = document.createElement('div');
        div.id = "chart" + numberchart;
        div.style = "width: 900px; height: 500px;";
        document.body.appendChild(div);
        //var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));
        var chart = new google.visualization.LineChart(div);
        chart.draw(data, options);
    }
    function GetWeekBegin(Day){
        var RealDay = new Date();
        RealDay.setTime(Date.parse(Day));
		const add = (RealDay.getDay() == 0) ? 7 : RealDay.getDay();
        RealDay.setHours(-24 * (add - 1));
        var mon = new Date(RealDay.getFullYear(), RealDay.getMonth(), RealDay.getDate());
        return mon;
    }
</script>

</body>

</html>
